"use strict";const e=require("../common/vendor.js"),t=require("../utils/cache.js");const o={}.VITE_API_URL||"https://your-api-domain.com/api/v1";let r=!1,n=[];async function a(a){const{url:s,method:i="GET",data:d,header:c={},showLoading:h=!1,showError:u=!0,timeout:l=6e4,useCache:g=!1,cacheTTL:m=3e5}=a;if("GET"===i&&g){const e=t.cache.get(s);if(e)return console.log(`[Request] 缓存命中: ${s}`),e}h&&e.index.showLoading({title:"加载中...",mask:!0});const f=e.index.getStorageSync("access_token"),w={"Content-Type":"application/json",...c};f&&(w.Authorization=`Bearer ${f}`);try{console.log(`[request] ${i} ${s} - timeout: ${l}ms`);const a=await e.index.request({url:o+s,method:i,data:d,header:w,timeout:l});if(h&&e.index.hideLoading(),401===a.statusCode){if(r)return new Promise((t,r)=>{var a;a=async n=>{try{w.Authorization=`Bearer ${n}`;const r=await e.index.request({url:o+s,method:i,data:d,header:w});t(r.data)}catch(a){r(a)}},n.push(a)});r=!0;try{const t=await async function(){const t=e.index.getStorageSync("refresh_token");if(!t)throw new Error("No refresh token");const r=await e.index.request({url:`${o}/auth/refresh`,method:"POST",data:{refresh_token:t},header:{"Content-Type":"application/json"}});if(200===r.statusCode){const t=r.data;return e.index.setStorageSync("access_token",t.access_token),e.index.setStorageSync("refresh_token",t.refresh_token),t.access_token}throw new Error("Token refresh failed")}();r=!1,function(e){n.forEach(t=>t(e)),n=[]}(t),w.Authorization=`Bearer ${t}`;return(await e.index.request({url:o+s,method:i,data:d,header:w})).data}catch(x){throw r=!1,e.index.removeStorageSync("access_token"),e.index.removeStorageSync("refresh_token"),e.index.reLaunch({url:"/pages/index/index"}),new Error("登录已过期，请重新登录")}}if(a.statusCode>=400){const t=a.data;let o="请求失败";throw"string"==typeof(null==t?void 0:t.detail)?o=t.detail:Array.isArray(null==t?void 0:t.detail)?o=t.detail.map(e=>e.msg).join("; "):"string"==typeof(null==t?void 0:t.message)?o=t.message:"string"==typeof t&&(o=t),console.error("API Error:",a.statusCode,t),u&&e.index.showToast({title:o,icon:"none"}),new Error(o)}return"GET"===i&&g&&(t.cache.set(s,a.data,m),console.log(`[Request] 已缓存: ${s}`)),a.data}catch(y){throw h&&e.index.hideLoading(),u&&y.message&&e.index.showToast({title:y.message,icon:"none"}),y}}const s={get:(e,t)=>a({url:e,method:"GET",...t}),post:(e,t,o)=>a({url:e,method:"POST",data:t,...o}),put:(e,t,o)=>a({url:e,method:"PUT",data:t,...o}),delete:(e,t)=>a({url:e,method:"DELETE",...t})};exports.request=s;
