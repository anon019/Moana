"use strict";const e=require("../../common/vendor.js"),l=require("../../stores/child.js"),a=require("../../stores/content.js"),t=require("../../api/play.js"),u=require("../../utils/time-limit.js"),n=require("../../utils/poster.js"),o=require("../../utils/performance.js"),r=e.defineComponent({__name:"picture-book",setup(r){const i=l.useChildStore(),v=a.useContentStore(),s=e.ref(""),c=e.ref(null),d=e.ref(!0),f=e.ref(0),g=e.ref(!0),p=e.ref(""),m=e.ref(!1),h=e.ref(0),_=e.ref(0),y=e.ref([]),x=e.ref(!1),w=e.ref(!1),b=e.ref(!1),S=e.ref(!1),I=e.ref(44),$=e.ref(!1),k=e.ref("rest"),C=e.ref(""),T=e.ref(""),L=e.ref(!1),P=e.getCurrentInstance();let M=null,j=null,q=null;const D=e.ref(!1),A=e.ref(new Map),B=e.computed(()=>{var e,l;return(null==(l=null==(e=c.value)?void 0:e.pages)?void 0:l.length)||0});function U(e){const l=[{top:"10%",left:"8%"},{top:"15%",left:"85%"},{top:"35%",left:"5%"},{top:"40%",left:"92%"},{top:"60%",left:"10%"},{top:"65%",left:"88%"},{top:"80%",left:"15%"},{top:"85%",left:"80%"}][e-1]||{top:"50%",left:"50%"},a=.5*e%4,t=4+e%3*2;return`top: ${l.top}; left: ${l.left}; width: ${t}rpx; height: ${t}rpx; animation-delay: ${a}s;`}function F(e){const l=e.detail.current;f.value=l,x.value=!1,m.value=!1,G(),W(l),V()}function R(){e.nextTick$1(()=>{x.value=!0,setTimeout(()=>{g.value&&N()},300)})}function E(){d.value||$.value||S.value||(g.value=!g.value,w.value=!g.value,g.value?setTimeout(()=>{w.value=!1,N()},500):(G(),Q()))}function W(l,a=3){var t,u;if(!(null==(u=null==(t=c.value)?void 0:t.pages)?void 0:u.length))return;const n=[];for(let e=l;e<=l+a&&e<c.value.pages.length;e++)n.push(e);l>0&&n.unshift(l-1),n.forEach((l,a)=>{const t=c.value.pages[l];t.image_thumb_url&&e.index.getImageInfo({src:t.image_thumb_url,success:()=>console.log(`[È¢ÑÂä†ËΩΩ] Áº©Áï•Âõæ ${l+1} ÂÆåÊàê`),fail:()=>{}}),!y.value[l]&&t.image_url&&setTimeout(()=>{e.index.downloadFile({url:t.image_url,success:e=>{200===e.statusCode&&(y.value[l]=!0,console.log(`[È¢ÑÂä†ËΩΩ] ÂéüÂõæ ${l+1} ÂÆåÊàê`))},fail:()=>{e.index.getImageInfo({src:t.image_url,success:()=>{y.value[l]=!0},fail:()=>{}})}})},200*a)})}function H(l){var a,t;if(!(null==(t=null==(a=c.value)?void 0:a.pages)?void 0:t.length))return;if(l<0||l>=c.value.pages.length)return;if(A.value.has(l))return;const u=c.value.pages[l];if(!u.audio_url)return;let n=u.audio_url;n.startsWith("http://")&&(n=n.replace("http://","https://")),console.log(`[È¢ÑÂä†ËΩΩ] ÂºÄÂßã‰∏ãËΩΩÈü≥È¢ë ${l+1}...`),e.index.downloadFile({url:n,success:e=>{200===e.statusCode&&e.tempFilePath&&(A.value.set(l,e.tempFilePath),console.log(`[È¢ÑÂä†ËΩΩ] Èü≥È¢ë ${l+1} ÂÆåÊàêÔºåÊú¨Âú∞Ë∑ØÂæÑ:`,e.tempFilePath))},fail:e=>{console.warn(`[È¢ÑÂä†ËΩΩ] Èü≥È¢ë ${l+1} Â§±Ë¥•:`,e)}})}function O(e,l=3){for(let a=e;a<e+l;a++)H(a)}function z(e,l=5e3){return new Promise(a=>{if(y.value[e])return void a(!0);const t=Date.now(),u=setInterval(()=>{y.value[e]?(clearInterval(u),a(!0)):Date.now()-t>l&&(clearInterval(u),console.warn(`[Á≠âÂæÖÂõæÁâá] È°µÈù¢ ${e+1} Ë∂ÖÊó∂`),a(!1))},100)})}async function N(){var l,a;if(!(null==(a=null==(l=c.value)?void 0:l.pages)?void 0:a.length)||!g.value)return;Q();const t=f.value,u=c.value.pages[t];if(u&&(y.value[t]||(console.log(`[ÁªòÊú¨] Á≠âÂæÖÈ°µÈù¢ ${t+1} ÂõæÁâáÂä†ËΩΩ...`),await z(t,5e3)),g.value))if(W(t+1,2),O(t+1,3),u.audio_url){if(M){try{M.destroy()}catch(n){}M=null}let l;D.value=!1;const a=await function(e,l=2e3){return new Promise(a=>{if(A.value.has(e))return void a(A.value.get(e));const t=Date.now(),u=setInterval(()=>{A.value.has(e)?(clearInterval(u),a(A.value.get(e))):Date.now()-t>l&&(clearInterval(u),a(null))},50)})}(t,2e3);if(a)l=a,console.log(`[ÁªòÊú¨Èü≥È¢ë] ‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠ò: ${t+1}`);else{let e=u.audio_url;e.startsWith("http://")&&(e=e.replace("http://","https://")),l=encodeURI(e),console.log(`[ÁªòÊú¨Èü≥È¢ë] ‰ΩøÁî®ÁΩëÁªúURL: ${t+1}`)}if(!g.value)return;try{e.index.setInnerAudioOption({obeyMuteSwitch:!1,mixWithOther:!0})}catch(n){}M=e.index.createInnerAudioContext(),M.volume=1,M.onPlay(()=>{console.log("[ÁªòÊú¨Èü≥È¢ë] Êí≠ÊîæÂºÄÂßã, È°µÈù¢:",t+1),D.value=!0}),M.onEnded(()=>{!function(){if(!g.value)return;setTimeout(()=>{J()},600)}()}),M.onError(e=>{console.error("[ÁªòÊú¨Èü≥È¢ë] Êí≠ÊîæÈîôËØØ:",(null==e?void 0:e.errMsg)||(null==e?void 0:e.errCode)||e),D.value=!1,K()}),M.src=l,setTimeout(()=>{M&&g.value&&M.play()},50)}else K()}function G(){if(M&&D.value)try{M.pause()}catch(e){}}async function J(){if(!g.value)return;let e=f.value+1;e>=B.value&&(e=0,console.log("[ÁªòÊú¨] Âæ™ÁéØÊí≠ÊîæÔºöÂõûÂà∞Á¨¨‰∏ÄÈ°µ")),y.value[e]||(console.log(`[ÁªòÊú¨] Á≠âÂæÖ‰∏ã‰∏ÄÈ°µ ${e+1} ÂõæÁâáÂä†ËΩΩ...`),await z(e,3e3)),g.value&&(f.value=e)}function K(){var e,l;if(Q(),!(null==(l=null==(e=c.value)?void 0:e.pages)?void 0:l.length)||!g.value)return;const a=c.value.pages[f.value],t=1e3*((null==a?void 0:a.duration)||5);j=setTimeout(()=>{J()},t)}function Q(){j&&(clearTimeout(j),j=null)}async function V(l=!1){if(!p.value)return;const a=Date.now();if(l||!(a-_.value<5e3)){_.value=a;try{const l=Math.round((a-h.value)/1e3);await t.updateProgress(p.value,f.value+1,l),e.index.setStorageSync(`play_progress_${s.value}`,{page:f.value,time:l,updatedAt:a})}catch(u){}}}function X(){L.value||e.index.navigateBack()}function Y(){const e=u.timeLimitManager.checkLimits();e.exceeded?(g.value=!1,Q(),G(),k.value=e.type||"session",C.value="daily"===e.type?"‰ªäÊó•Êó∂Èó¥Âà∞":"‰ºëÊÅØÊó∂Èó¥Âà∞",T.value=e.message,$.value=!0):e.reminder&&(g.value=!1,Q(),G(),k.value="rest",C.value="ÁúºÁùõ‰ºëÊÅØ",T.value=e.message,$.value=!0)}function Z(){$.value=!1,u.timeLimitManager.resetReminder(),g.value=!0,N()}function ee(){$.value=!1,"rest"!==k.value?e.index.navigateBack():u.timeLimitManager.resetReminder()}function le(){g.value=!1,Q(),G(),e.index.navigateBack()}async function ae(){var l,a,t;if(c.value&&!L.value){L.value=!0,e.index.showLoading({title:"ÁîüÊàêÊµ∑Êä•‰∏≠...",mask:!0});try{const u=await n.generatePoster("posterCanvas",{title:c.value.title||"Á´•ËØùÁªòÊú¨",coverUrl:(null==(a=null==(l=c.value.pages)?void 0:l[0])?void 0:a.image_url)||c.value.cover_url||"",childName:(null==(t=i.currentChild)?void 0:t.name)||"ÂÆùË¥ù",theme:c.value.theme_topic||""},P);e.index.hideLoading(),await n.savePosterToAlbum(u),e.index.showToast({title:"Â∑≤‰øùÂ≠òÂà∞Áõ∏ÂÜå",icon:"success"})}catch(u){e.index.hideLoading(),console.error("[Êµ∑Êä•ÁîüÊàêÂ§±Ë¥•]",u),e.index.showToast({title:u.message||"ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï",icon:"none"})}finally{L.value=!1}}}function te(){var l,a;if(!(null==(a=null==(l=c.value)?void 0:l.pages)?void 0:a.length))return;y.value=new Array(c.value.pages.length).fill(!1),A.value.clear(),console.log(`[ÁªòÊú¨] ÂºÄÂßãÈ¢ÑÂä†ËΩΩÔºåÂÖ± ${c.value.pages.length} È°µ`),W(0,5),O(0,3),async function(){var e;if(!i.currentChild||!c.value)return;if(!c.value.id)return void console.warn("[startPlaySession] Áº∫Â∞ë content.idÔºåË∑≥ËøáÊí≠Êîæ‰ºöËØùÂàõÂª∫");try{const l=await t.startPlay(i.currentChild.id,c.value.id,"picture_book");p.value=l.play_history_id,h.value=Date.now(),(null==(e=l.resumed_from)?void 0:e.page)>0&&(f.value=l.resumed_from.page-1)}catch(l){console.warn("[startPlaySession] Êí≠Êîæ‰ºöËØùÂàõÂª∫Â§±Ë¥•")}}(),u.timeLimitManager.ensureSession(),q=setInterval(Y,3e4);e.index.getStorageSync("storybook_hint_seen")||(b.value=!0,setTimeout(()=>{b.value=!1,e.index.setStorageSync("storybook_hint_seen",!0)},3e3))}return e.onLoad(l=>{o.perf.clear(),o.perf.mark("pageLoad"),s.value=(null==l?void 0:l.id)||"";const a=e.index.getSystemInfoSync();I.value=a.statusBarHeight||44,"1"===(null==l?void 0:l.autoplay)&&(g.value=!0)}),e.onMounted(()=>{!async function(){const l=e.index.getStorageSync("temp_picture_book");if(l)return console.log("[loadContent] ‰ΩøÁî®‰∏¥Êó∂Â≠òÂÇ®Êï∞ÊçÆ"),c.value=l,e.index.removeStorageSync("temp_picture_book"),o.perf.measure("Êï∞ÊçÆÂä†ËΩΩÔºà‰∏¥Êó∂Â≠òÂÇ®Ôºâ","pageLoad"),te(),void(d.value=!1);const a=v.currentContent;if(a&&(!s.value||a.id===s.value))return console.log("[loadContent] ‰ΩøÁî® store Êï∞ÊçÆ, ID:",a.id),c.value=a,o.perf.measure("Êï∞ÊçÆÂä†ËΩΩÔºàStore ÁºìÂ≠òÔºâ","pageLoad"),te(),void(d.value=!1);if(s.value)try{await v.fetchContentDetail(s.value),c.value=v.currentContent,o.perf.measure("API ÂìçÂ∫îÊó∂Èó¥","pageLoad"),te()}catch(t){e.index.showToast({title:"Âä†ËΩΩÂ§±Ë¥•",icon:"none"}),setTimeout(()=>e.index.navigateBack(),1500)}finally{d.value=!1}else d.value=!1}()}),e.onShareAppMessage(()=>{var e,l;return{title:(null==(e=c.value)?void 0:e.title)||"Êù•ÁúãËøô‰∏™ÊúâË∂£ÁöÑÁªòÊú¨",path:`/pages/play/picture-book?id=${s.value}`,imageUrl:(null==(l=c.value)?void 0:l.cover_url)||""}}),e.onShareTimeline(()=>{var e,l;return{title:(null==(e=c.value)?void 0:e.title)||"Êù•ÁúãËøô‰∏™ÊúâË∂£ÁöÑÁªòÊú¨",query:`id=${s.value}`,imageUrl:(null==(l=c.value)?void 0:l.cover_url)||""}}),e.onUnmounted(()=>{V(!0),Q(),q&&clearInterval(q),null==M||M.destroy()}),(l,a)=>{var t,u,n,r;return e.e({a:e.f(8,(l,a,t)=>({a:l,b:e.s(U(l))})),b:c.value},c.value?{c:e.f(c.value.pages,(l,a,t)=>e.e({a:l.image_thumb_url&&!y.value[a]},l.image_thumb_url&&!y.value[a]?{b:l.image_thumb_url}:{},{c:l.image_url},l.image_url?{d:y.value[a]?1:"",e:l.image_url,f:e.o(e=>function(e){y.value[e]=!0,0===e&&o.perf.measure("È¶ñÂõæÂä†ËΩΩÊó∂Èó¥","pageLoad"),e!==f.value||x.value||setTimeout(()=>{x.value=!0,g.value&&N()},200)}(a),a),g:e.o(e=>function(e){y.value[e]=!0}(a),a)}:{},{h:!l.image_thumb_url&&!y.value[a]},(l.image_thumb_url||y.value[a],{}),{i:e.t(l.text),j:e.t(a+1),k:f.value===a&&x.value?1:"",l:a})),d:e.t((null==(u=null==(t=c.value)?void 0:t.pages)?void 0:u.length)||0),e:f.value,f:e.o(F),g:e.o(R)}:{},{h:e.o(le),i:e.f(3,(e,l,a)=>({a:e})),j:g.value?1:"",k:I.value+"px",l:e.f((null==(n=c.value)?void 0:n.pages)||[],(e,l,a)=>({a:l,b:l===f.value?1:"",c:l<f.value?1:""})),m:b.value},(b.value,{}),{n:w.value},(w.value,{}),{o:d.value},(d.value,{}),{p:S.value},S.value?{q:e.f(5,(e,l,a)=>({a:e,b:.1*e+"s"})),r:e.t(null==(r=c.value)?void 0:r.title),s:e.o(ae),t:e.o(X)}:{},{v:$.value},$.value?e.e({w:e.t("rest"===k.value?"üåô":"üò¥"),x:e.t(C.value),y:e.t(T.value),z:"rest"===k.value},"rest"===k.value?{A:e.o(Z)}:{},{B:e.t("rest"===k.value?"‰ºëÊÅØ‰∏Ä‰∏ã":"Â•ΩÁöÑ"),C:e.o(ee)}):{},{D:e.o(E)})}}});r.__runtimeHooks=6;const i=e._export_sfc(r,[["__scopeId","data-v-43b61679"]]);wx.createPage(i);
