"use strict";const e=require("../../common/vendor.js"),t=require("../../api/content.js"),l=e.defineComponent({__name:"nursery-rhyme",setup(l){const u=e.ref(""),n=e.ref(null),a=e.ref(!0),o=e.ref(!1),r=e.ref(0),i=e.ref(0),s=e.ref(20),v=e.ref(!1),c=e.ref(!1),d=e.ref(!1),f=e.ref(0),p=e.ref(0),m=e.computed(()=>{var e;return(null==(e=n.value)?void 0:e.all_tracks)||[]}),h=e.computed(()=>m.value.length>1),g=e.computed(()=>{var e;return!!(null==(e=n.value)?void 0:e.video_url)}),y=e.ref(null),x=e.ref(!1),_=e.ref(!0),w=e.ref([]),$=e.ref([]),b=e.ref(0),k=e.ref(0);function M(){if(0===$.value.length||b.value<0)return;const t=`#lyric-${b.value}`;e.index.createSelectorQuery().select(".lyrics-scroll").boundingClientRect().select(t).boundingClientRect().exec(e=>{if(!e||!e[0]||!e[1])return;const t=e[0],l=e[1];if(!t||!l)return;const u=l.top-t.top,n=k.value+u-t.height/2+l.height/2;k.value=Math.max(0,n)})}const C=e.ref(0),S=e.ref(.5),T=e.computed(()=>0===C.value?150:Math.max(120,C.value/2-20));let A=null;function j(){var e;(null==(e=n.value)?void 0:e.cover_url)&&console.log("[nursery-rhyme] È¢ÑÂä†ËΩΩÂ∞ÅÈù¢:",n.value.cover_url)}function I(e){const t=[{top:"8%",left:"15%"},{top:"12%",left:"75%"},{top:"25%",left:"88%"},{top:"35%",left:"5%"},{top:"45%",left:"92%"},{top:"55%",left:"8%"},{top:"65%",left:"85%"},{top:"75%",left:"12%"},{top:"82%",left:"78%"},{top:"18%",left:"45%"},{top:"68%",left:"55%"},{top:"88%",left:"35%"}],l=t[(e-1)%t.length],u=.3*e%3,n=.3+e%5*.15;return`top: ${l.top}; left: ${l.left}; animation-delay: ${u}s; opacity: ${n};`}function B(e){const t=[{left:"10%",top:"30%"},{left:"85%",top:"25%"},{left:"20%",top:"60%"},{left:"75%",top:"55%"},{left:"50%",top:"40%"}],l=t[(e-1)%t.length],u=1.5*e,n=e%2==0?"#FF6B9D":"#9B6BFF";return`left: ${l.left}; top: ${l.top}; animation-delay: ${u}s; color: ${n};`}const R=e.computed(()=>d.value?f.value:0===i.value?0:r.value/i.value*100);function z(e){if(!e.all_tracks||0===e.all_tracks.length)return L(e);const t=e.all_tracks[0];return t.timestamped_lyrics&&t.timestamped_lyrics.length>0?{...e,lyrics:{full_text:t.lyric||"",timestamped:t.timestamped_lyrics}}:t.lyric?{...e,lyrics:t.lyric}:L(e)}function L(e){if(!e.lyrics||"object"!=typeof e.lyrics)return e;const t=e.lyrics;if(!t.timestamped||!Array.isArray(t.timestamped))return e;const l=t.timestamped;if(l.length<50)return e;for(let u=1;u<l.length;u++){const n=l[u-1].start_s||0;if((l[u].start_s||0)<n-30)return{...e,lyrics:{...t,timestamped:l.slice(0,u)}}}return e}const O={verse:"„Äê‰∏ªÊ≠å„Äë",chorus:"„ÄêÂâØÊ≠å„Äë",bridge:"„ÄêÊ°•ÊÆµ„Äë",intro:"„ÄêÂâçÂ•è„Äë",outro:"„ÄêÂ∞æÂ•è„Äë","pre-chorus":"„ÄêÈ¢ÑÂâØÊ≠å„Äë","pre chorus":"„ÄêÈ¢ÑÂâØÊ≠å„Äë",hook:"„ÄêËÆ∞ÂøÜÁÇπ„Äë",refrain:"„ÄêÂâØÊ≠å„Äë",interlude:"„ÄêÈó¥Â•è„Äë"};function Z(e){return!!e&&/^„Äê.+„Äë$/.test(e.trim())}function E(e){let t=e;t=t.replace(/\[([A-Za-z][A-Za-z\s-]*)(?:\s*\d*)?\]/gi,(e,t)=>{const l=t.toLowerCase().trim().replace(/\s+/g,"-");return O[l]||O[l.replace(/-/g," ")]||O[l.replace(/-/g,"")]||""}),t=t.replace(/\*\*([A-Za-z][A-Za-z\s-]*)(?:\s*\d*)?\*\*/gi,(e,t)=>{const l=t.toLowerCase().trim().replace(/\s+/g,"-");return O[l]||O[l.replace(/-/g," ")]||""});const l=Object.keys(O).join("|").replace(/-/g,"[- ]?"),u=new RegExp(`^\\s*(${l})(?:\\s*\\d*)?\\s*:?\\s*$`,"i"),n=t.match(u);if(n){const e=n[1].toLowerCase().trim().replace(/\s+/g,"-");t=O[e]||O[e.replace(/-/g," ")]||""}return t.replace(/[\n\r]/g," ").trim()}function F(e,t){if(!e)return{lines:[],data:[]};if("object"==typeof e&&e.timestamped&&Array.isArray(e.timestamped)){console.log("[Ê≠åËØç] ‰ΩøÁî®ÂêéÁ´ØÁ≤æÁ°ÆÊó∂Èó¥Êà≥ÔºåËØçÊï∞:",e.timestamped.length);const t=[],l=[];let u="",n=-1,a="";for(const o of e.timestamped){let e=o.word||"";const r=o.start_s||0;if(e=e.replace(/\[(Verse|Chorus|Bridge|Intro|Outro|Pre-?Chorus|Hook|Refrain|Interlude)(?:\s*\d*)?\]/gi,(e,t)=>{const l=t.toLowerCase().trim().replace(/\s+/g,"-"),u=O[l]||O[l.replace(/-/g," ")]||"";return u?`\n${u}\n`:""}),e.includes("\n")){const o=e.split("\n").filter(e=>e.trim());for(const e of o)/^„Äê.+„Äë$/.test(e.trim())?(u.trim()&&(t.push(u.trim()),l.push({time:n,text:u.trim()}),u="",n=-1),t.push(e.trim()),l.push({time:r,text:e.trim()})):(u+=e,n<0&&(n=r),a=e);continue}const i=e.match(/„Äê[^„Äë]+„Äë/);if(i){if(u.trim()){const e=E(u);e&&(t.push(e),l.push({time:n,text:e})),u="",n=-1}t.push(i[0]),l.push({time:r,text:i[0]});const o=e.replace(i[0],"").trim();o&&(u=o,n=r),a=e;continue}if(u&&("\n"===e||/^[„ÄÇÔºÅÔºü\n]$/.test(e)||n>=0&&r-n>3.5||/[a-z]$/.test(a)&&/^[A-Z]/.test(e)||/[„ÄÇÔºÅÔºü]$/.test(u))&&u.trim()){const e=E(u);e&&(t.push(e),l.push({time:n,text:e})),u="",n=-1}if(e&&"\n"!==e&&(n<0&&(n=r),u+=e.replace(/[\n\r]/g,""),a=e),/[„ÄÇÔºÅÔºü]$/.test(u)){const e=E(u);e&&(t.push(e),l.push({time:n,text:e})),u="",n=-1}}if(u.trim()){const e=E(u);e&&(t.push(e),l.push({time:n>=0?n:0,text:e}))}if(t.length>0)return{lines:t,data:l}}let l="";if("string"==typeof e?l=e:"object"==typeof e&&(l=e.full_text||"",!l&&e.sections&&(l=e.sections.map(e=>e.content).join("\n\n"))),!l)return{lines:[],data:[]};l=l.replace(/\\n/g,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/\r\n/g,"\n").replace(/\r/g,"\n");const u=l.split("\n").map(e=>e.trim()).filter(e=>e.length>0),n=/^\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/;if(u.some(e=>n.test(e))){const e=[];for(const t of u){const l=t.match(n);if(l){const u=60*parseInt(l[1],10)+parseInt(l[2],10)+(l[3]?parseInt(l[3].padEnd(3,"0"),10):0)/1e3,a=E(t.replace(n,"").trim());a&&u>=0&&e.push({time:u,text:a})}}return e.sort((e,t)=>e.time-t.time),{lines:e.map(e=>e.text),data:e}}const a=u.map(e=>E(e)).filter(e=>e.length>0);if(0===a.length||0===t)return{lines:a,data:[]};const o=Math.min(6,.1*t),r=t-o-Math.min(10,.15*t),i=a.reduce((e,t)=>e+Math.max(t.length,3),0),s=[];let v=o;for(const c of a){s.push({time:v,text:c});v+=r*(Math.max(c.length,3)/i)}return{lines:a,data:s}}e.watch(()=>{var e;return[null==(e=n.value)?void 0:e.lyrics,i.value]},([e,t])=>{if(e&&t>0){const l=F(e,t);$.value=l.lines,w.value=l.data,b.value=0,console.log("[Ê≠åËØçËß£Êûê] Ë°åÊï∞:",l.lines.length,"Êó∂Èó¥Êà≥Êï∞:",l.data.length)}else if(e){const t=F(e,0);$.value=t.lines,w.value=[],b.value=0}},{immediate:!0}),e.watch(()=>i.value,e=>{var t;if(e>0&&$.value.length>0&&0===w.value.length){const l=F(null==(t=n.value)?void 0:t.lyrics,e);w.value=l.data,console.log("[Ê≠åËØçÊó∂Èó¥Êà≥] ÈáçÊñ∞ËÆ°ÁÆóÔºåÊó∂Èó¥Êà≥Êï∞:",l.data.length)}});const P={cheerful:"üéâ Ê¨¢Âø´Ê¥ªÊ≥º",gentle:"üå∏ Ê∏©ÊüîËàíÁºì",playful:"üéà ‰øèÁöÆÂèØÁà±",lullaby:"üåô ÊëáÁØÆÊõ≤È£é",educational:"üìö ÂêØËíôÊïôËÇ≤"};function Q(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}function U(){A&&(o.value?(o.value=!1,A.pause(),y.value&&g.value&&_.value&&y.value.pause()):(o.value=!0,A.play(),y.value&&g.value&&_.value&&y.value.play()))}function W(){console.log("[ËßÜÈ¢ë] Âä†ËΩΩÂÆåÊàê"),x.value=!0}function X(t){console.error("[ËßÜÈ¢ë] Âä†ËΩΩÂ§±Ë¥•:",t),_.value=!1,e.index.showToast({title:"ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∑≤ÂàáÊç¢Âà∞Âî±ÁâáÊ®°Âºè",icon:"none"})}function q(){g.value&&(y.value=e.index.createVideoContext("suno-video"),console.log("[ËßÜÈ¢ë] ‰∏ä‰∏ãÊñáÂàùÂßãÂåñ"))}function H(){A&&(A.seek(0),b.value=0,r.value=0,o.value=!0,A.play(),y.value&&g.value&&_.value&&(y.value.seek(0),y.value.play()))}function D(){if(!h.value)return;const t=(p.value+1)%m.value.length;p.value=t;const l=m.value[t];l&&(A&&A.stop(),n.value&&(n.value={...n.value,audio_url:l.audio_url,cover_url:l.cover_url||n.value.cover_url,duration:l.duration||n.value.duration,lyrics:l.timestamped_lyrics?{full_text:l.lyric||"",timestamped:l.timestamped_lyrics}:n.value.lyrics}),i.value=l.duration||0,r.value=0,b.value=0,ee(),e.index.showToast({title:`ÂàáÊç¢Âà∞ÁâàÊú¨ ${t+1}`,icon:"none",duration:1500}))}let V=null;function G(t){var l,u;if(!A||0===i.value||d.value)return;const n=(null==(l=t.touches)?void 0:l[0])||(null==(u=t.changedTouches)?void 0:u[0])||t.detail;n&&e.index.createSelectorQuery().select(".progress-track").boundingClientRect(e=>{if(!e)return;const t=(n.clientX||n.pageX)-e.left,l=Math.max(0,Math.min(1,t/e.width))*i.value;null==A||A.seek(l),r.value=l}).exec()}function J(t){var l;if(!A||0===i.value)return;const u=null==(l=t.touches)?void 0:l[0];u&&e.index.createSelectorQuery().select(".progress-track").boundingClientRect(e=>{if(!e)return;V={left:e.left,width:e.width},d.value=!0;const t=u.clientX-e.left;f.value=Math.max(0,Math.min(100,t/e.width*100))}).exec()}function K(e){var t;if(!d.value||!V)return;const l=null==(t=e.touches)?void 0:t[0];if(!l)return;const u=l.clientX-V.left;f.value=Math.max(0,Math.min(100,u/V.width*100))}function N(){if(!d.value||!A)return d.value=!1,void(V=null);const e=f.value/100*i.value;A.seek(e),r.value=e,y.value&&g.value&&_.value&&y.value.seek(e),d.value=!1,V=null}function Y(){A&&(A.stop(),A.destroy()),e.index.navigateBack()}function ee(){var t;if(!(null==(t=n.value)?void 0:t.audio_url))return;try{e.index.setInnerAudioOption({obeyMuteSwitch:!1,mixWithOther:!1})}catch(u){}A&&(A.stop(),A.destroy()),A=e.index.createInnerAudioContext(),A.volume=1;let l=n.value.audio_url;l.startsWith("http://")&&(l=l.replace("http://","https://")),A.onCanplay(()=>{c.value=!1,(null==A?void 0:A.duration)&&A.duration>0&&(i.value=A.duration)}),A.onPlay(()=>{o.value=!0}),A.onPause(()=>{o.value=!1}),A.onStop(()=>{o.value=!1}),A.onEnded(()=>{r.value=0,b.value=0,null==A||A.seek(0),null==A||A.play()}),A.onTimeUpdate(()=>{r.value=(null==A?void 0:A.currentTime)||0,(null==A?void 0:A.duration)&&A.duration>0&&(i.value=A.duration),function(){if(0===$.value.length)return;const e=r.value+.4,t=w.value;if(t.length>0){let l=0;for(let u=t.length-1;u>=0;u--)if(t[u].time<=e){l=u;break}return void(l!==b.value&&(b.value=l,setTimeout(()=>M(),50)))}if(0===i.value)return;const l=e/i.value,u=Math.min(Math.floor(l*$.value.length),$.value.length-1);u!==b.value&&u>=0&&(b.value=u,setTimeout(()=>M(),50))}()}),A.onError(t=>{console.error("Èü≥È¢ëÈîôËØØ:",t),e.index.showToast({title:"Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•",icon:"none"})}),A.onWaiting(()=>{c.value=!0}),A.src=l,setTimeout(()=>{null==A||A.play()},500)}async function te(){a.value=!0;try{const l=e.index.getStorageSync("temp_nursery_rhyme");if(console.log("[nursery-rhyme] ‰∏¥Êó∂Â≠òÂÇ®Êï∞ÊçÆ:",l),console.log("[nursery-rhyme] ‰∏¥Êó∂Â≠òÂÇ®Êï∞ÊçÆ keys:",l?Object.keys(l):"null"),l){const t=z(l);return n.value=t,console.log("[nursery-rhyme] ËÆæÁΩÆ song.value"),console.log("[nursery-rhyme] video_url:",t.video_url),e.index.removeStorageSync("temp_nursery_rhyme"),i.value=t.duration||0,j(),ee(),setTimeout(()=>q(),300),void(a.value=!1)}if(u.value){const e=z(await t.getContentDetail(u.value));n.value=e,i.value=n.value.duration||0,j(),ee(),setTimeout(()=>q(),300)}}catch(l){console.error("Âä†ËΩΩÂÑøÊ≠åÂ§±Ë¥•:",l),e.index.showToast({title:"Âä†ËΩΩÂ§±Ë¥•",icon:"none"}),setTimeout(()=>e.index.navigateBack(),1500)}finally{a.value=!1}}return e.onShareAppMessage(()=>{var e,t;return{title:(null==(e=n.value)?void 0:e.title)||"Êù•Âê¨ËøôÈ¶ñÊúâË∂£ÁöÑÂÑøÊ≠å",path:`/pages/play/nursery-rhyme?id=${u.value}`,imageUrl:(null==(t=n.value)?void 0:t.cover_url)||""}}),e.onShareTimeline(()=>{var e,t;return{title:(null==(e=n.value)?void 0:e.title)||"Êù•Âê¨ËøôÈ¶ñÊúâË∂£ÁöÑÂÑøÊ≠å",query:`id=${u.value}`,imageUrl:(null==(t=n.value)?void 0:t.cover_url)||""}}),e.onLoad(t=>{console.log("[nursery-rhyme] onLoad, options:",t),u.value=(null==t?void 0:t.id)||"";const l=e.index.getSystemInfoSync();s.value=l.statusBarHeight||20,S.value=l.windowWidth/750,console.log("[Ê≠åËØçÊªöÂä®] rpxËΩ¨pxÊØî‰æã:",S.value),te()}),e.onMounted(()=>{console.log("[nursery-rhyme] onMounted, song.value:",n.value?"loaded":"null"),n.value||(console.log("[nursery-rhyme] onMounted: ÈáçÊñ∞Â∞ùËØïÂä†ËΩΩ"),te()),setTimeout(()=>{e.index.createSelectorQuery().select(".lyrics-scroll").boundingClientRect(e=>{e&&e.height>0&&(C.value=e.height,console.log("[Ê≠åËØç] ÂÆπÂô®È´òÂ∫¶:",e.height,"px"))}).exec()},300)}),e.onUnmounted(()=>{A&&(A.stop(),A.destroy(),A=null)}),(t,l)=>{var u,y,x,w,M,C,S,A,j,z,L,O;return e.e({a:e.f(12,(t,l,u)=>({a:t,b:e.s(I(t))})),b:e.f(5,(t,l,u)=>({a:t,b:e.s(B(t))})),c:e.o(Y),d:e.t((null==(u=n.value)?void 0:u.title)||"Ê≠£Âú®Êí≠Êîæ"),e:s.value+"px",f:g.value&&_.value},g.value&&_.value?e.e({g:null==(y=n.value)?void 0:y.video_url,h:null==(x=n.value)?void 0:x.cover_url,i:e.o(W),j:e.o(X),k:!o.value},(o.value,{}),{l:e.o(U),m:e.t((null==(w=n.value)?void 0:w.title)||"ÂÑøÊ≠å"),n:e.o(e=>_.value=!1)}):e.e({o:o.value?1:"",p:null==(M=n.value)?void 0:M.cover_url},(null==(C=n.value)?void 0:C.cover_url)?{q:n.value.cover_url,r:e.o(e=>v.value=!0)}:{},{s:o.value?1:"",t:g.value},g.value?{v:e.o(e=>_.value=!0)}:{}),{w:e.t((null==(S=n.value)?void 0:S.title)||"ÂÑøÊ≠å"),x:e.t((null==(j=null==(A=n.value)?void 0:A.personalization)?void 0:j.child_name)||"ÂÆùË¥ù"),y:T.value+"px",z:e.f($.value,(t,l,u)=>e.e({a:Z(t)&&l>0},(Z(t),{}),{b:e.t(t),c:"lyric-"+l,d:l===b.value?1:"",e:l<b.value?1:"",f:Z(t)?1:"",g:l})),A:T.value+"px",B:0===$.value.length},($.value.length,{}),{C:k.value,D:e.t(Q(d.value?f.value/100*i.value:r.value)),E:R.value+"%",F:d.value?1:"",G:R.value+"%",H:d.value?1:"",I:e.o(G),J:e.o(J),K:e.o(K),L:e.o(N),M:e.o(N),N:e.t(Q(i.value)),O:e.o(H),P:c.value},(c.value||o.value,{}),{Q:o.value,R:o.value?1:"",S:o.value},(o.value,{}),{T:o.value},(o.value,{}),{U:e.o(U),V:h.value},h.value?{W:e.t(p.value+1),X:e.t(m.value.length),Y:e.o(D)}:{},{Z:h.value},h.value?{aa:e.t(p.value+1)}:{},{ab:null==(z=n.value)?void 0:z.music_style},(null==(L=n.value)?void 0:L.music_style)?{ac:e.t((O=n.value.music_style,P[O]||O))}:{},{ad:a.value},(a.value,{}))}}});l.__runtimeHooks=6;const u=e._export_sfc(l,[["__scopeId","data-v-b50e7b79"]]);wx.createPage(u);
