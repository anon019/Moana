"use strict";const e=require("../common/vendor.js");function t(e,t,l,i,s,n){e.beginPath(),e.moveTo(t+n,l),e.lineTo(t+i-n,l),e.arcTo(t+i,l,t+i,l+n,n),e.lineTo(t+i,l+s-n),e.arcTo(t+i,l+s,t+i-n,l+s,n),e.lineTo(t+n,l+s),e.arcTo(t,l+s,t,l+s-n,n),e.lineTo(t,l+n),e.arcTo(t,l,t+n,l,n),e.closePath()}exports.generatePoster=async function(l,i,s){const n=e.index.createCanvasContext(l,s),o=540;n.setFillStyle("#FFF9F5"),n.fillRect(0,0,o,960),n.setFillStyle("#FF7B54"),n.fillRect(0,0,o,80),n.setFillStyle("#FFFFFF"),n.setFontSize(32),n.setTextAlign("center"),n.fillText("ç«¥è¯ç»˜æœ¬",270,52);try{const l=await async function(t){return new Promise((l,i)=>{let s=t;s.startsWith("http://")&&(s=s.replace("http://","https://")),e.index.downloadFile({url:s,success:e=>{200===e.statusCode?l(e.tempFilePath):i(new Error("å›¾ç‰‡ä¸‹è½½å¤±è´¥"))},fail:i})})}(i.coverUrl);n.save(),t(n,40,120,460,400,16),n.clip(),n.drawImage(l,40,120,460,400),n.restore()}catch(a){n.save(),t(n,40,120,460,400,16),n.setFillStyle("#FFE4D6"),n.fill(),n.restore(),n.setFillStyle("#FF7B54"),n.setFontSize(80),n.setTextAlign("center"),n.fillText("ðŸ“š",270,340)}n.setFillStyle("#3D2914"),n.setFontSize(36),n.setTextAlign("center");let r=i.title;return r.length>12&&(r=r.substring(0,12)+"..."),n.fillText(r,270,580),i.theme&&(n.setFillStyle("#FF7B54"),n.setFontSize(24),n.fillText(`#${i.theme}`,270,630)),n.setFillStyle("#9C8578"),n.setFontSize(28),n.fillText(`${i.childName} çš„ä¸“å±žç»˜æœ¬`,270,700),n.setStrokeStyle("#FFE4D6"),n.setLineWidth(2),n.beginPath(),n.moveTo(120,760),n.lineTo(420,760),n.stroke(),n.setFillStyle("#FF7B54"),n.setFontSize(28),n.fillText("Moana ç«¥è¯ç»˜æœ¬",270,820),n.setFillStyle("#C4B5A9"),n.setFontSize(22),n.fillText("é•¿æŒ‰è¯†åˆ«å°ç¨‹åºç ï¼Œåˆ›ä½œä¸“å±žç»˜æœ¬",270,900),new Promise((t,i)=>{n.draw(!1,()=>{setTimeout(()=>{e.index.canvasToTempFilePath({canvasId:l,success:e=>t(e.tempFilePath),fail:i},s)},100)})})},exports.savePosterToAlbum=async function(t){return new Promise((l,i)=>{e.index.saveImageToPhotosAlbum({filePath:t,success:()=>l(),fail:t=>{var l,s;((null==(l=t.errMsg)?void 0:l.includes("auth deny"))||(null==(s=t.errMsg)?void 0:s.includes("authorize")))&&e.index.showModal({title:"éœ€è¦ç›¸å†Œæƒé™",content:"è¯·åœ¨è®¾ç½®ä¸­å…è®¸è®¿é—®ç›¸å†Œï¼Œä»¥ä¿å­˜æµ·æŠ¥å›¾ç‰‡",confirmText:"åŽ»è®¾ç½®",success:t=>{t.confirm&&e.index.openSetting({})}}),i(t)}})})};
